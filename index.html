<!-- Tela de Login -->
<div id="loginView" class="container d-flex justify-content-center align-items-center vh-100">
  <div class="card p-4" style="min-width: 350px;">
    <h4 class="text-center mb-3">Sistema Pós-Obra</h4>
    <p class="text-center">Faça login para acessar o sistema</p>
    <div class="mb-3">
      <label for="loginEmail" class="form-label">Email</label>
      <input type="email" class="form-control" id="loginEmail" placeholder="admin@admin.com">
    </div>
    <div class="mb-3">
      <label for="loginSenha" class="form-label">Senha</label>
      <input type="password" class="form-control" id="loginSenha" placeholder="Sua senha">
    </div>
    <button class="btn btn-primary w-100" onclick="fazerLogin()">Entrar</button>
    <div class="mt-3 small">
      <strong>Credenciais de teste:</strong><br>
      Admin: admin@admin.com / admin123<br>
      Usuário: usuario@teste.com / 123456
    </div>
  </div>
</div>

<!-- Página de Obras separada -->
<div id="obrasView" class="container my-4 hidden">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Obras</h2>
    <button class="btn btn-secondary" onclick="mostrarDashboard()">← Voltar ao Dashboard</button>
  </div>
  <div class="mb-3">
    <input id="filtroObra" class="form-control" placeholder="Filtrar por nome ou responsável" oninput="filtrarObras()">
  </div>
  <ul class="list-group" id="listaCompletaObras"></ul>
</div>

<script>
  const usuariosTeste = {
    "admin@admin.com": "admin123",
    "usuario@teste.com": "123456"
  };

  function fazerLogin() {
    const email = document.getElementById("loginEmail").value;
    const senha = document.getElementById("loginSenha").value;
    if (usuariosTeste[email] && usuariosTeste[email] === senha) {
      document.getElementById("loginView").classList.add("hidden");
      document.getElementById("appView").classList.remove("hidden");
    } else {
      alert("Credenciais inválidas");
    }
  }

  function mostrarObrasView() {
    document.getElementById("appView").classList.add("hidden");
    document.getElementById("obrasView").classList.remove("hidden");
    carregarObrasCompleta();
  }

  function mostrarDashboard() {
    document.getElementById("obrasView").classList.add("hidden");
    document.getElementById("appView").classList.remove("hidden");
  }

  function carregarObrasCompleta() {
    const lista = document.getElementById("listaCompletaObras");
    lista.innerHTML = "Carregando...";
    db.ref("obras").once("value", snapshot => {
      const obras = snapshot.val() || {};
      lista.innerHTML = "";
      Object.entries(obras).forEach(([key, o]) => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.innerHTML = `
          <strong>${o.nome}</strong><br>
          Responsável: ${o.responsavel}<br>
          Endereço: ${o.endereco}<br>
          <input type='file' class='form-control mt-2' onchange='uploadDocumento(this, "${key}")'>
          <small class='text-muted'>Enviar documento</small>
          <ul class='mt-2' id='docs-${key}'></ul>
        `;
        lista.appendChild(li);
        listarDocumentosObra(key);
      });
    });
  }

  function listarDocumentosObra(obraId) {
    const storageRef = firebase.storage().ref(`documentos/${obraId}`);
    const ul = document.getElementById(`docs-${obraId}`);
    storageRef.listAll().then(result => {
      result.items.forEach(itemRef => {
        itemRef.getDownloadURL().then(url => {
          const li = document.createElement("li");
          li.innerHTML = `<a href='${url}' target='_blank'>${itemRef.name}</a>`;
          ul.appendChild(li);
        });
      });
    });
  }

  function filtrarObras() {
    const filtro = document.getElementById("filtroObra").value.toLowerCase();
    const items = document.querySelectorAll("#listaCompletaObras li");
    items.forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(filtro) ? "block" : "none";
    });
  }

  function uploadDocumento(input, obraId) {
    const file = input.files[0];
    if (!file) return;
    const storageRef = firebase.storage().ref(`documentos/${obraId}/${file.name}`);
    storageRef.put(file).then(snapshot => {
      alert("Documento enviado com sucesso para " + obraId);
      listarDocumentosObra(obraId);
    }).catch(err => alert("Erro ao enviar documento: " + err));
  }
</script>
